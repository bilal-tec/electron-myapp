<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Expense Tracker with VAT</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, button {
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background-color: #45a049;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: none;
            margin-right: 5px;
        }
        .tab.active {
            background-color: #4CAF50;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .vat-section {
            background-color: #f9f9f9;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Project Expense Tracker with VAT</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="openTab('projects')">Projects</button>
            <button class="tab" onclick="openTab('expenses')">Expenses</button>
            <button class="tab" onclick="openTab('income')">Income</button>
            <button class="tab" onclick="openTab('reports')">Reports</button>
            <button class="tab" onclick="openTab('dashboard')">Dashboard</button>
        </div>
        
        <!-- Projects Tab -->
        <div id="projects" class="tab-content active">
            <h2>Manage Projects</h2>
            <div class="section">
                <h3>Add New Project</h3>
                <div class="form-group">
                    <label for="projectName">Project Name</label>
                    <input type="text" id="projectName" placeholder="Enter project name">
                </div>
                <div class="form-group">
                    <label for="projectBudget">Budget ($)</label>
                    <input type="number" id="projectBudget" placeholder="Enter project budget">
                </div>
                <div class="form-group">
                    <label for="projectStart">Start Date</label>
                    <input type="date" id="projectStart">
                </div>
                <div class="form-group">
                    <label for="projectEnd">End Date</label>
                    <input type="date" id="projectEnd">
                </div>
                <button onclick="addProject()">Add Project</button>
            </div>
            
            <div class="section">
                <h3>Your Projects</h3>
                <table id="projectsTable">
                    <thead>
                        <tr>
                            <th>Project Name</th>
                            <th>Budget</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <!-- Expenses Tab -->
        <div id="expenses" class="tab-content">
            <h2>Track Expenses</h2>
            <div class="section">
                <h3>Add New Expense</h3>
                <div class="form-group">
                    <label for="expenseProject">Project</label>
                    <select id="expenseProject"></select>
                </div>
                <div class="form-group">
                    <label for="expenseDate">Date</label>
                    <input type="date" id="expenseDate">
                </div>
                <div class="form-group">
                    <label for="expenseCategory">Category</label>
                    <select id="expenseCategory">
                        <option value="Materials">Materials</option>
                        <option value="Labor">Labor</option>
                        <option value="Equipment">Equipment</option>
                        <option value="Transportation">Transportation</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="expenseAmount">Amount ($)</label>
                    <input type="number" id="expenseAmount" placeholder="Enter amount">
                </div>
                <div class="form-group">
                    <label for="expenseDescription">Description</label>
                    <input type="text" id="expenseDescription" placeholder="Enter description">
                </div>
                
                <!-- VAT Section for Expenses -->
                <div class="vat-section">
                    <h4>VAT Information</h4>
                    <div class="form-group">
                        <label for="expenseVatRate">VAT Rate (%)</label>
                        <input type="number" id="expenseVatRate" placeholder="Enter VAT rate" value="20">
                    </div>
                    <div class="form-group">
                        <label for="expenseVatNumber">Supplier VAT Number</label>
                        <input type="text" id="expenseVatNumber" placeholder="Enter supplier VAT number">
                    </div>
                    <div class="form-group">
                        <label for="expenseVatAmount">VAT Amount (auto-calculated)</label>
                        <input type="number" id="expenseVatAmount" placeholder="VAT amount" readonly>
                    </div>
                    <div class="form-group">
                        <label for="expenseTotalAmount">Total Amount (incl. VAT)</label>
                        <input type="number" id="expenseTotalAmount" placeholder="Total amount" readonly>
                    </div>
                </div>
                
                <button onclick="addExpense()">Add Expense</button>
            </div>
            
            <div class="section">
                <h3>Expense History</h3>
                <div class="form-group">
                    <label for="filterExpenseProject">Filter by Project</label>
                    <select id="filterExpenseProject" onchange="filterExpenses()">
                        <option value="all">All Projects</option>
                    </select>
                </div>
                <table id="expensesTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Project</th>
                            <th>Category</th>
                            <th>Amount</th>
                            <th>VAT</th>
                            <th>Total</th>
                            <th>VAT Number</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <!-- Income Tab -->
        <div id="income" class="tab-content">
            <h2>Track Income</h2>
            <div class="section">
                <h3>Add New Income</h3>
                <div class="form-group">
                    <label for="incomeProject">Project</label>
                    <select id="incomeProject"></select>
                </div>
                <div class="form-group">
                    <label for="incomeDate">Date</label>
                    <input type="date" id="incomeDate">
                </div>
                <div class="form-group">
                    <label for="incomeAmount">Amount ($)</label>
                    <input type="number" id="incomeAmount" placeholder="Enter amount">
                </div>
                <div class="form-group">
                    <label for="incomeSource">Source</label>
                    <input type="text" id="incomeSource" placeholder="Enter source">
                </div>
                
                <!-- VAT Section for Income -->
                <div class="vat-section">
                    <h4>VAT Information</h4>
                    <div class="form-group">
                        <label for="incomeVatRate">VAT Rate (%)</label>
                        <input type="number" id="incomeVatRate" placeholder="Enter VAT rate" value="20">
                    </div>
                    <div class="form-group">
                        <label for="incomeVatNumber">Customer VAT Number</label>
                        <input type="text" id="incomeVatNumber" placeholder="Enter customer VAT number">
                    </div>
                    <div class="form-group">
                        <label for="incomeVatAmount">VAT Amount (auto-calculated)</label>
                        <input type="number" id="incomeVatAmount" placeholder="VAT amount" readonly>
                    </div>
                    <div class="form-group">
                        <label for="incomeTotalAmount">Total Amount (incl. VAT)</label>
                        <input type="number" id="incomeTotalAmount" placeholder="Total amount" readonly>
                    </div>
                </div>
                
                <button onclick="addIncome()">Add Income</button>
            </div>
            
            <div class="section">
                <h3>Income History</h3>
                <div class="form-group">
                    <label for="filterIncomeProject">Filter by Project</label>
                    <select id="filterIncomeProject" onchange="filterIncome()">
                        <option value="all">All Projects</option>
                    </select>
                </div>
                <table id="incomeTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Project</th>
                            <th>Amount</th>
                            <th>VAT</th>
                            <th>Total</th>
                            <th>VAT Number</th>
                            <th>Source</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <h2>Monthly Reports</h2>
            <div class="section">
                <div class="form-group">
                    <label for="reportProject">Select Project</label>
                    <select id="reportProject" onchange="generateReport()"></select>
                </div>
                <div class="form-group">
                    <label for="reportMonth">Select Month</label>
                    <input type="month" id="reportMonth" onchange="generateReport()">
                </div>
                
                <div id="reportResults">
                    <h3>Monthly Summary</h3>
                    <div id="reportSummary"></div>
                    
                    <h3>VAT Summary</h3>
                    <div id="vatSummary"></div>
                    
                    <h3>Expense Breakdown</h3>
                    <div class="chart-container">
                        <canvas id="expenseChart"></canvas>
                    </div>
                    
                    <h3>Detailed Transactions</h3>
                    <table id="reportTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Category/Source</th>
                                <th>Amount</th>
                                <th>VAT</th>
                                <th>Total</th>
                                <th>VAT Number</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    
                    <button onclick="exportReport()">Export to PDF</button>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <h2>Project Dashboard</h2>
            <div class="section">
                <div class="form-group">
                    <label for="dashboardProject">Select Project</label>
                    <select id="dashboardProject" onchange="updateDashboard()"></select>
                </div>
                
                <div class="chart-container">
                    <canvas id="budgetChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="vatChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
                
                <div id="projectStats">
                    <h3>Project Statistics</h3>
                    <div id="statsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let projects = [];
        let expenses = [];
        let income = [];
        
        // Chart instances
        let expenseChart = null;
        let budgetChart = null;
        let vatChart = null;
        let timelineChart = null;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateProjectDropdowns();
            renderProjectsTable();
            renderExpensesTable();
            renderIncomeTable();
            
            // Set up VAT amount calculators
            document.getElementById('expenseAmount').addEventListener('input', calculateExpenseVat);
            document.getElementById('expenseVatRate').addEventListener('input', calculateExpenseVat);
            document.getElementById('incomeAmount').addEventListener('input', calculateIncomeVat);
            document.getElementById('incomeVatRate').addEventListener('input', calculateIncomeVat);
        });
        
        // VAT Calculation Functions
        function calculateExpenseVat() {
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const vatRate = parseFloat(document.getElementById('expenseVatRate').value) || 0;
            const vatAmount = amount * (vatRate / 100);
            const totalAmount = amount + vatAmount;
            
            document.getElementById('expenseVatAmount').value = vatAmount.toFixed(2);
            document.getElementById('expenseTotalAmount').value = totalAmount.toFixed(2);
        }
        
        function calculateIncomeVat() {
            const amount = parseFloat(document.getElementById('incomeAmount').value) || 0;
            const vatRate = parseFloat(document.getElementById('incomeVatRate').value) || 0;
            const vatAmount = amount * (vatRate / 100);
            const totalAmount = amount + vatAmount;
            
            document.getElementById('incomeVatAmount').value = vatAmount.toFixed(2);
            document.getElementById('incomeTotalAmount').value = totalAmount.toFixed(2);
        }
        
        // Tab navigation
        function openTab(tabName) {
            const tabs = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            const tabButtons = document.getElementsByClassName('tab');
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
            
            // Update charts when dashboard is opened
            if (tabName === 'dashboard') {
                updateDashboard();
            }
        }
        
        // Data management functions
        function loadData() {
            const savedData = localStorage.getItem('projectTrackerData');
            if (savedData) {
                const data = JSON.parse(savedData);
                projects = data.projects || [];
                expenses = data.expenses || [];
                income = data.income || [];
            }
        }
        
        function saveData() {
            const data = {
                projects: projects,
                expenses: expenses,
                income: income
            };
            localStorage.setItem('projectTrackerData', JSON.stringify(data));
        }
        
        // Project functions
        function addProject() {
            const name = document.getElementById('projectName').value;
            const budget = parseFloat(document.getElementById('projectBudget').value);
            const start = document.getElementById('projectStart').value;
            const end = document.getElementById('projectEnd').value;
            
            if (!name || isNaN(budget) || !start || !end) {
                alert('Please fill all fields with valid data');
                return;
            }
            
            projects.push({
                id: Date.now().toString(),
                name: name,
                budget: budget,
                start: start,
                end: end
            });
            
            saveData();
            updateProjectDropdowns();
            renderProjectsTable();
            
            // Clear form
            document.getElementById('projectName').value = '';
            document.getElementById('projectBudget').value = '';
            document.getElementById('projectStart').value = '';
            document.getElementById('projectEnd').value = '';
        }
        
        function deleteProject(id) {
            if (confirm('Are you sure you want to delete this project? All related expenses and income will also be deleted.')) {
                projects = projects.filter(project => project.id !== id);
                expenses = expenses.filter(expense => expense.projectId !== id);
                income = income.filter(item => item.projectId !== id);
                saveData();
                updateProjectDropdowns();
                renderProjectsTable();
                renderExpensesTable();
                renderIncomeTable();
            }
        }
        
        function updateProjectDropdowns() {
            const dropdowns = [
                document.getElementById('expenseProject'),
                document.getElementById('incomeProject'),
                document.getElementById('reportProject'),
                document.getElementById('dashboardProject'),
                document.getElementById('filterExpenseProject'),
                document.getElementById('filterIncomeProject')
            ];
            
            dropdowns.forEach(dropdown => {
                if (!dropdown) return;
                
                // Save current selection
                const currentValue = dropdown.value;
                
                // Clear options
                dropdown.innerHTML = '';
                
                // Add default option if needed
                if (dropdown.id === 'filterExpenseProject' || dropdown.id === 'filterIncomeProject' || 
                    dropdown.id === 'reportProject' || dropdown.id === 'dashboardProject') {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = 'all';
                    defaultOption.textContent = dropdown.id.includes('filter') ? 'All Projects' : 'Select Project';
                    dropdown.appendChild(defaultOption);
                }
                
                // Add project options
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    dropdown.appendChild(option);
                });
                
                // Restore selection if possible
                if (projects.some(project => project.id === currentValue)) {
                    dropdown.value = currentValue;
                }
            });
        }
        
        function renderProjectsTable() {
            const tbody = document.querySelector('#projectsTable tbody');
            tbody.innerHTML = '';
            
            projects.forEach(project => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${project.name}</td>
                    <td>$${project.budget.toFixed(2)}</td>
                    <td>${project.start}</td>
                    <td>${project.end}</td>
                    <td>
                        <button onclick="deleteProject('${project.id}')">Delete</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // Expense functions
        function addExpense() {
            const projectId = document.getElementById('expenseProject').value;
            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const description = document.getElementById('expenseDescription').value;
            const vatRate = parseFloat(document.getElementById('expenseVatRate').value);
            const vatNumber = document.getElementById('expenseVatNumber').value;
            const vatAmount = parseFloat(document.getElementById('expenseVatAmount').value) || 0;
            const totalAmount = parseFloat(document.getElementById('expenseTotalAmount').value) || amount;
            
            if (!projectId || !date || isNaN(amount) || !description) {
                alert('Please fill all required fields with valid data');
                return;
            }
            
            expenses.push({
                id: Date.now().toString(),
                projectId: projectId,
                date: date,
                category: category,
                amount: amount,
                vatRate: vatRate,
                vatAmount: vatAmount,
                totalAmount: totalAmount,
                vatNumber: vatNumber,
                description: description
            });
            
            saveData();
            renderExpensesTable();
            
            // Clear form
            document.getElementById('expenseDate').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseVatNumber').value = '';
            document.getElementById('expenseVatAmount').value = '';
            document.getElementById('expenseTotalAmount').value = '';
        }
        
        function deleteExpense(id) {
            if (confirm('Are you sure you want to delete this expense?')) {
                expenses = expenses.filter(expense => expense.id !== id);
                saveData();
                renderExpensesTable();
            }
        }
        
        function filterExpenses() {
            renderExpensesTable();
        }
        
        function renderExpensesTable() {
            const tbody = document.querySelector('#expensesTable tbody');
            tbody.innerHTML = '';
            
            const projectFilter = document.getElementById('filterExpenseProject').value;
            
            let filteredExpenses = expenses;
            if (projectFilter !== 'all') {
                filteredExpenses = expenses.filter(expense => expense.projectId === projectFilter);
            }
            
            filteredExpenses.forEach(expense => {
                const project = projects.find(p => p.id === expense.projectId);
                const projectName = project ? project.name : 'Unknown Project';
                
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${expense.date}</td>
                    <td>${projectName}</td>
                    <td>${expense.category}</td>
                    <td>$${expense.amount.toFixed(2)}</td>
                    <td>$${expense.vatAmount.toFixed(2)} (${expense.vatRate}%)</td>
                    <td>$${expense.totalAmount.toFixed(2)}</td>
                    <td>${expense.vatNumber || '-'}</td>
                    <td>${expense.description}</td>
                    <td>
                        <button onclick="deleteExpense('${expense.id}')">Delete</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // Income functions
        function addIncome() {
            const projectId = document.getElementById('incomeProject').value;
            const date = document.getElementById('incomeDate').value;
            const amount = parseFloat(document.getElementById('incomeAmount').value);
            const source = document.getElementById('incomeSource').value;
            const vatRate = parseFloat(document.getElementById('incomeVatRate').value);
            const vatNumber = document.getElementById('incomeVatNumber').value;
            const vatAmount = parseFloat(document.getElementById('incomeVatAmount').value) || 0;
            const totalAmount = parseFloat(document.getElementById('incomeTotalAmount').value) || amount;
            
            if (!projectId || !date || isNaN(amount) || !source) {
                alert('Please fill all required fields with valid data');
                return;
            }
            
            income.push({
                id: Date.now().toString(),
                projectId: projectId,
                date: date,
                amount: amount,
                vatRate: vatRate,
                vatAmount: vatAmount,
                totalAmount: totalAmount,
                vatNumber: vatNumber,
                source: source
            });
            
            saveData();
            renderIncomeTable();
            
            // Clear form
            document.getElementById('incomeDate').value = '';
            document.getElementById('incomeAmount').value = '';
            document.getElementById('incomeSource').value = '';
            document.getElementById('incomeVatNumber').value = '';
            document.getElementById('incomeVatAmount').value = '';
            document.getElementById('incomeTotalAmount').value = '';
        }
        
        function deleteIncome(id) {
            if (confirm('Are you sure you want to delete this income record?')) {
                income = income.filter(item => item.id !== id);
                saveData();
                renderIncomeTable();
            }
        }
        
        function filterIncome() {
            renderIncomeTable();
        }
        
        function renderIncomeTable() {
            const tbody = document.querySelector('#incomeTable tbody');
            tbody.innerHTML = '';
            
            const projectFilter = document.getElementById('filterIncomeProject').value;
            
            let filteredIncome = income;
            if (projectFilter !== 'all') {
                filteredIncome = income.filter(item => item.projectId === projectFilter);
            }
            
            filteredIncome.forEach(item => {
                const project = projects.find(p => p.id === item.projectId);
                const projectName = project ? project.name : 'Unknown Project';
                
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${item.date}</td>
                    <td>${projectName}</td>
                    <td>$${item.amount.toFixed(2)}</td>
                    <td>$${item.vatAmount.toFixed(2)} (${item.vatRate}%)</td>
                    <td>$${item.totalAmount.toFixed(2)}</td>
                    <td>${item.vatNumber || '-'}</td>
                    <td>${item.source}</td>
                    <td>
                        <button onclick="deleteIncome('${item.id}')">Delete</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // Report functions
        function generateReport() {
            const projectId = document.getElementById('reportProject').value;
            const month = document.getElementById('reportMonth').value;
            
            if (projectId === 'all' || !month) {
                document.getElementById('reportResults').style.display = 'none';
                return;
            }
            
            document.getElementById('reportResults').style.display = 'block';
            
            // Find project
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            // Filter transactions for the selected month
            const yearMonth = month + '-';
            const projectExpenses = expenses.filter(e => 
                e.projectId === projectId && e.date.startsWith(yearMonth));
            const projectIncome = income.filter(i => 
                i.projectId === projectId && i.date.startsWith(yearMonth));
            
            // Calculate totals
            const totalExpenses = projectExpenses.reduce((sum, e) => sum + e.amount, 0);
            const totalExpenseVat = projectExpenses.reduce((sum, e) => sum + e.vatAmount, 0);
            const totalIncome = projectIncome.reduce((sum, i) => sum + i.amount, 0);
            const totalIncomeVat = projectIncome.reduce((sum, i) => sum + i.vatAmount, 0);
            const net = (totalIncome + totalIncomeVat) - (totalExpenses + totalExpenseVat);
            
            // Update summary
            document.getElementById('reportSummary').innerHTML = `
                <p><strong>Project:</strong> ${project.name}</p>
                <p><strong>Month:</strong> ${month}</p>
                <p><strong>Total Income:</strong> $${totalIncome.toFixed(2)} + $${totalIncomeVat.toFixed(2)} VAT</p>
                <p><strong>Total Expenses:</strong> $${totalExpenses.toFixed(2)} + $${totalExpenseVat.toFixed(2)} VAT</p>
                <p><strong>Net:</strong> $${net.toFixed(2)}</p>
            `;
            
            // Update VAT summary
            document.getElementById('vatSummary').innerHTML = `
                <p><strong>VAT to Pay:</strong> $${(totalIncomeVat - totalExpenseVat).toFixed(2)}</p>
                <p><strong>VAT Collected:</strong> $${totalIncomeVat.toFixed(2)}</p>
                <p><strong>VAT Paid:</strong> $${totalExpenseVat.toFixed(2)}</p>
            `;
            
            // Update expense chart
            updateExpenseChart(projectExpenses);
            
            // Update report table
            const tbody = document.querySelector('#reportTable tbody');
            tbody.innerHTML = '';
            
            // Add income records
            projectIncome.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.date}</td>
                    <td>Income</td>
                    <td>${item.source}</td>
                    <td>$${item.amount.toFixed(2)}</td>
                    <td>$${item.vatAmount.toFixed(2)}</td>
                    <td>$${item.totalAmount.toFixed(2)}</td>
                    <td>${item.vatNumber || '-'}</td>
                    <td></td>
                `;
                tbody.appendChild(row);
            });
            
            // Add expense records
            projectExpenses.forEach(expense => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${expense.date}</td>
                    <td>Expense</td>
                    <td>${expense.category}</td>
                    <td>$${expense.amount.toFixed(2)}</td>
                    <td>$${expense.vatAmount.toFixed(2)}</td>
                    <td>$${expense.totalAmount.toFixed(2)}</td>
                    <td>${expense.vatNumber || '-'}</td>
                    <td>${expense.description}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateExpenseChart(expenses) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            // Group expenses by category
            const categories = {};
            expenses.forEach(expense => {
                if (!categories[expense.category]) {
                    categories[expense.category] = 0;
                }
                categories[expense.category] += expense.totalAmount;
            });
            
            // Destroy previous chart if exists
            if (expenseChart) {
                expenseChart.destroy();
            }
            
            // Create new chart
            expenseChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF',
                            '#FF9F40'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Expense Breakdown by Category (Incl. VAT)'
                        }
                    }
                }
            });
        }
        
        function exportReport() {
            alert('In a real application, this would generate a PDF report. For this demo, you can print the page (Ctrl+P).');
        }
        
        // Dashboard functions
        function updateDashboard() {
            const projectId = document.getElementById('dashboardProject').value;
            
            if (projectId === 'all') {
                document.getElementById('projectStats').style.display = 'none';
                return;
            }
            
            document.getElementById('projectStats').style.display = 'block';
            
            // Find project
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            // Filter transactions for this project
            const projectExpenses = expenses.filter(e => e.projectId === projectId);
            const projectIncome = income.filter(i => i.projectId === projectId);
            
            // Calculate totals
            const totalExpenses = projectExpenses.reduce((sum, e) => sum + e.amount, 0);
            const totalExpenseVat = projectExpenses.reduce((sum, e) => sum + e.vatAmount, 0);
            const totalIncome = projectIncome.reduce((sum, i) => sum + i.amount, 0);
            const totalIncomeVat = projectIncome.reduce((sum, i) => sum + i.vatAmount, 0);
            const remainingBudget = project.budget - totalExpenses;
            const percentageUsed = (totalExpenses / project.budget) * 100;
            
            // Update stats
            document.getElementById('statsContent').innerHTML = `
                <p><strong>Project Budget:</strong> $${project.budget.toFixed(2)}</p>
                <p><strong>Total Expenses:</strong> $${totalExpenses.toFixed(2)} + $${totalExpenseVat.toFixed(2)} VAT</p>
                <p><strong>Remaining Budget:</strong> $${remainingBudget.toFixed(2)}</p>
                <p><strong>Budget Used:</strong> ${percentageUsed.toFixed(1)}%</p>
                <p><strong>Total Income:</strong> $${totalIncome.toFixed(2)} + $${totalIncomeVat.toFixed(2)} VAT</p>
                <p><strong>Net Profit/Loss:</strong> $${(totalIncome - totalExpenses).toFixed(2)}</p>
                <p><strong>VAT Liability:</strong> $${(totalIncomeVat - totalExpenseVat).toFixed(2)}</p>
            `;
            
            // Update budget chart
            updateBudgetChart(project, totalExpenses, totalIncome);
            
            // Update VAT chart
            updateVatChart(totalIncomeVat, totalExpenseVat);
            
            // Update timeline chart
            updateTimelineChart(projectExpenses, projectIncome);
        }
        
        function updateBudgetChart(project, totalExpenses, totalIncome) {
            const ctx = document.getElementById('budgetChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (budgetChart) {
                budgetChart.destroy();
            }
            
            // Create new chart
            budgetChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Budget', 'Expenses', 'Income'],
                    datasets: [{
                        label: 'Amount ($)',
                        data: [project.budget, totalExpenses, totalIncome],
                        backgroundColor: [
                            '#36A2EB',
                            '#FF6384',
                            '#4BC0C0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Budget vs Expenses vs Income (Excl. VAT)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function updateVatChart(incomeVat, expenseVat) {
            const ctx = document.getElementById('vatChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (vatChart) {
                vatChart.destroy();
            }
            
            // Create new chart
            vatChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['VAT Collected', 'VAT Paid'],
                    datasets: [{
                        data: [incomeVat, expenseVat],
                        backgroundColor: [
                            '#FFCE56',
                            '#FF6384'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'VAT Summary'
                        }
                    }
                }
            });
        }
        
        function updateTimelineChart(expenses, income) {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            // Group by date
            const expenseByDate = {};
            expenses.forEach(expense => {
                if (!expenseByDate[expense.date]) {
                    expenseByDate[expense.date] = 0;
                }
                expenseByDate[expense.date] += expense.totalAmount;
            });
            
            const incomeByDate = {};
            income.forEach(item => {
                if (!incomeByDate[item.date]) {
                    incomeByDate[item.date] = 0;
                }
                incomeByDate[item.date] += item.totalAmount;
            });
            
            // Get all unique dates
            const allDates = [...new Set([
                ...Object.keys(expenseByDate),
                ...Object.keys(incomeByDate)
            ])].sort();
            
            // Prepare data
            const expenseData = allDates.map(date => expenseByDate[date] || 0);
            const incomeData = allDates.map(date => incomeByDate[date] || 0);
            
            // Destroy previous chart if exists
            if (timelineChart) {
                timelineChart.destroy();
            }
            
            // Create new chart
            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allDates,
                    datasets: [
                        {
                            label: 'Expenses (Incl. VAT)',
                            data: expenseData,
                            borderColor: '#FF6384',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'Income (Incl. VAT)',
                            data: incomeData,
                            borderColor: '#4BC0C0',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            fill: true,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Daily Expenses and Income Over Time (Incl. VAT)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>